- name: Initialize pi
  hosts: all
  become: true
  strategy: linear
  # serial: 1

  pre_tasks:
  # add check if keepalived should be restarted.
    - name: Ensure keepalived service is stopped
      ansible.builtin.service:
        name: keepalived
        state: stopped
      register: result
      failed_when:
        - result.failed == true
        - '"Could not find the requested service" not in result.msg'

  roles:
    # - stop_keepalived
    - role: bootstrap
    - role: updates
    - role: sshd
    - role: geerlingguy.docker
    - role: pihole
    - role: keepalived
    - role: orbital_sync
      # - start_keepalived

  post_tasks:
  # add check if keepalived should be restarted.
    - name: Ensure keepalived service is started
      ansible.builtin.service:
        name: keepalived
        state: started
      register: result
      failed_when:
        - result.failed == true
        - '"Could not find the requested service" not in result.msg'
